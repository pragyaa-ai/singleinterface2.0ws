# üîÑ v4.3.0 Webhook Updates Summary

**Branch:** `v4.3.0-webhook-updates`  
**Base Version:** v4.3.0  
**Date:** October 10, 2025  
**Status:** Ready for Deployment

---

## üìã Overview

This branch contains comprehensive webhook updates for v4.3.0 to integrate with both **SingleInterface API v2.0** and **Waybeo Telephony API**. All updates are production-ready and tested.

---

## ‚ú® What Was Updated

### **1. SingleInterface Webhook ‚Üí v2.0** üéØ

Updated to match SingleInterface's new API requirements.

#### **New Fields Added:**
- `Store_code` (number) - Store identifier
- `Customer_number` (number) - Customer phone number

#### **Field Changes:**
- `duration` ‚Üí `Duration` (capital D)
- `call_vendor`: "Ozonetel" ‚Üí "Waybeo"

#### **Updated Values:**
- **Dealer routing reasons**: Standardized to 3 values
  - `"call completed"`
  - `"User decided"`
  - `"Unable to understand answers"`
  
- **Dropoff actions**: Extended to support
  - `ivr`, `name`, `model`, `email`, `qq1`, `qq2`

**Documentation:** `WEBHOOK_V2_UPDATE.md`

---

### **2. Waybeo Telephony Webhook** üìû

New integration to send call data to Waybeo's bot-call API.

#### **Waybeo Endpoint:**
```
POST https://pbx-uat.waybeo.com/bot-call
Authorization: Bearer <TOKEN>
```

#### **Payload Format:**
```json
{
  "call_id": "74lJ3xiezGf4zOo-DJXGZ",
  "command": "data_record",
  "parameters": [
    {"key": "bot_reference_id", "value": "bot_74lJ3xiezGf4zOo-DJXGZ"},
    {"key": "data_capture_status", "value": "complete"}
  ]
}
```

#### **Parameters Sent (Only 2):**
- **bot_reference_id** (always) - Bot identifier with call ID
- **data_capture_status** (always) - `"none"`, `"partial"`, or `"complete"`

#### **What's NOT Sent:**
- Customer name, email, phone number
- Car model or other collected data  
- Call duration or timing details
- Conversation language
- Any personally identifiable information (PII)

**All customer data is only sent to SingleInterface webhook, not to telephony webhook.**

**Documentation:** `WAYBEO_TELEPHONY_WEBHOOK.md`

---

## üìÅ Files Modified

### **Core Service Files:**

#### **1. `src/services/webhookService.js`**

**SingleInterface Webhook Changes:**
- Added `extractStoreCode()` method
- Added `extractCustomerNumber()` method
- Updated `transformToSingleInterfaceFormat()` with new fields
- Changed field names and vendor
- Updated dealer routing reasons
- Extended dropoff action mapping

**Waybeo Webhook Changes:**
- Added `transformToWaybeoFormat()` method
- Updated `deliverTelephonyWebhook()` for Waybeo integration
- Added `makeWaybeoWebhookRequest()` with Bearer token auth
- Updated `processWebhooks()` to pass transcriptData

#### **2. `src/app/api/webhooks/singleinterface/route.ts`**
- Updated to v2.0 API documentation
- Added new fields to logging
- Updated health check endpoint with v2.0 details
- Added supported dealer_routing_reasons and dropoff_actions

#### **3. `src/app/api/webhooks/telephony/route.ts`**
- Updated documentation for Waybeo integration
- Added required environment variables
- Documented expected payload format

### **Documentation Files:**

- **WEBHOOK_V2_UPDATE.md** - Complete SingleInterface v2.0 documentation
- **WAYBEO_TELEPHONY_WEBHOOK.md** - Complete Waybeo integration guide
- **V4.3.0_WEBHOOK_UPDATES_SUMMARY.md** (this file)

---

## ‚öôÔ∏è Environment Variables Required

Add these to your `.env` file on GCP VM:

```bash
# SingleInterface Webhook (v2.0)
# Store_code and Customer_number will be extracted from call metadata
# Or use defaults: Store_code=10001, Customer_number=9999999999

# Waybeo Telephony Webhook
WAYBEO_WEBHOOK_URL=https://pbx-uat.waybeo.com/bot-call
WAYBEO_AUTH_TOKEN=<Bearer_token_from_Waybeo>

# General Webhook Settings
WEBHOOKS_ENABLED=true
WEBHOOK_RETRY_ATTEMPTS=3
WEBHOOK_TIMEOUT_MS=10000
```

### **Important:**
- `WAYBEO_AUTH_TOKEN` is **required** - get from Waybeo team
- Token provided in documentation is a sample/expired token
- Request production token for live environment

---

## üöÄ Deployment Steps

### **1. Prepare GCP VM:**

```bash
# SSH into your GCP VM
gcloud compute ssh your-vm --zone=your-zone

# Navigate to project directory
cd /opt/voiceagent
```

### **2. Deploy Updated Code:**

```bash
# Fetch latest from repository
git fetch origin

# Checkout webhook updates branch
git checkout v4.3.0-webhook-updates

# Pull latest changes
git pull origin v4.3.0-webhook-updates

# Verify you're on correct branch
git branch --show-current
# Should show: v4.3.0-webhook-updates
```

### **3. Configure Environment:**

```bash
# Edit .env file
nano .env

# Add/Update these variables:
# WAYBEO_WEBHOOK_URL=https://pbx-uat.waybeo.com/bot-call
# WAYBEO_AUTH_TOKEN=<YOUR_TOKEN_HERE>

# Save and exit (Ctrl+X, Y, Enter)

# Secure the file
chmod 600 .env
```

### **4. Rebuild Application:**

```bash
# Install any new dependencies
npm install

# Rebuild Next.js (if needed)
npm run build
```

### **5. Restart Services:**

```bash
# Restart Next.js app (for SingleInterface webhook endpoint)
pm2 restart voiceagent-next

# Restart queue processor (reads webhookService.js)
pm2 restart voiceagent-queue-processor

# Verify all services are running
pm2 status

# Expected output: All services should show "online"
```

### **6. Verify Deployment:**

```bash
# Check SingleInterface webhook health (v2.0)
curl https://your-domain.com/api/webhooks/singleinterface | jq

# Should show:
# "api_version": "2.0"
# "supported_fields": [...includes Store_code, Customer_number, Duration]

# Monitor logs
pm2 logs voiceagent-queue-processor --lines 100
```

### **7. Test with Real Call:**

```bash
# Make a test call
# Then monitor logs for webhook delivery:

pm2 logs voiceagent-queue-processor | grep -A 5 "webhook"

# Expected log patterns:
# üöÄ Processing webhooks...
# üìû Waybeo webhook delivered successfully: 200
# üìä Sent 6 parameters to Waybeo
# üéØ Single Interface webhook delivered successfully: 200
# üì° Webhook summary: 2 delivered, 0 failed
```

---

## ‚úÖ Deployment Checklist

### **Pre-Deployment:**
- [ ] Code reviewed and tested
- [ ] Waybeo auth token obtained
- [ ] Environment variables prepared
- [ ] Backup of current code taken

### **Deployment:**
- [ ] Branch checked out: `v4.3.0-webhook-updates`
- [ ] Git pull completed successfully
- [ ] `.env` file updated with Waybeo token
- [ ] Services restarted (voiceagent-next, voiceagent-queue-processor)
- [ ] PM2 status shows all services "online"

### **Verification:**
- [ ] SingleInterface webhook health check shows v2.0
- [ ] Test call made successfully
- [ ] Waybeo webhook delivery logged (check PM2 logs)
- [ ] SingleInterface webhook delivery logged
- [ ] "Webhook summary" shows successful delivery
- [ ] Waybeo team confirms data received
- [ ] No errors in PM2 error logs

### **Post-Deployment:**
- [ ] Monitor first 10 calls for webhook success
- [ ] Verify all parameters being sent correctly
- [ ] Check for any authentication errors
- [ ] Document any issues encountered

---

## üß™ Testing Guide

### **1. Test SingleInterface Webhook:**

```bash
# Test health endpoint
curl https://your-domain.com/api/webhooks/singleinterface | jq

# Expected response includes:
# - "api_version": "2.0"
# - "Store_code" in supported_fields
# - "Customer_number" in supported_fields
# - "Duration" (capital D) in supported_fields
# - dealer_routing_reasons array
# - dropoff_actions array with qq1, qq2

# Test POST (manual)
curl -X POST https://your-domain.com/api/webhooks/singleinterface \
  -H "Content-Type: application/json" \
  -d '{
    "id": "bot_test",
    "call_ref_id": "test123",
    "call_vendor": "Waybeo",
    "start_time": "2025-10-10 10:00:00",
    "end_time": "2025-10-10 10:05:00",
    "Duration": 300,
    "Store_code": 10001,
    "Customer_number": 9898989898
  }'
```

### **2. Test Waybeo Webhook:**

```bash
# Direct test to Waybeo (with real token)
curl --location 'https://pbx-uat.waybeo.com/bot-call' \
  --header 'Content-Type: application/json' \
  --header 'Authorization: Bearer YOUR_TOKEN_HERE' \
  --data '{
    "call_id": "test-direct-123",
    "command": "data_record",
    "parameters": [
      {"key": "customer_name", "value": "Test Customer"},
      {"key": "call_status", "value": "complete"}
    ]
  }'

# Expected: 200 OK or similar success response
```

### **3. End-to-End Test:**

```bash
# Make a real test call through your system
# Capture:
# - Customer name
# - Car model  
# - Email address

# Monitor both webhook deliveries:
pm2 logs voiceagent-queue-processor --lines 200 | grep -E "(Processing webhooks|Waybeo|Single Interface|Webhook summary)"

# Should see:
# üöÄ Processing webhooks...
# üìû Waybeo webhook delivered successfully: 200
# üìä Sent 6 parameters to Waybeo
# üéØ Single Interface webhook delivered successfully: 200
# üìä Delivered: 3 data points, duration: 120s
# üì° Webhook summary: 2 delivered, 0 failed
```

---

## üêõ Troubleshooting

### **Issue: Waybeo webhook fails with 401 Unauthorized**

**Symptoms:**
```
‚ùå Waybeo webhook failed: HTTP 401: Unauthorized
```

**Fix:**
1. Check `WAYBEO_AUTH_TOKEN` is set in `.env`
2. Verify token is correct (copy-paste carefully)
3. Token may have expired - request new one from Waybeo
4. Restart queue processor after updating token: `pm2 restart voiceagent-queue-processor`

---

### **Issue: SingleInterface webhook missing new fields**

**Symptoms:**
- `Store_code` or `Customer_number` not in payload
- Field still named `duration` (lowercase)

**Fix:**
1. Verify you're on `v4.3.0-webhook-updates` branch
2. Check git log shows recent v2.0 commit
3. Restart voiceagent-next: `pm2 restart voiceagent-next`
4. Clear any caches

---

### **Issue: No webhooks being sent**

**Symptoms:**
```
üìû Telephony webhook disabled by config
üéØ Single Interface webhook disabled by config
```

**Fix:**
Check `.env` file:
```bash
# Ensure WEBHOOKS_ENABLED is true (or not set, defaults to true)
WEBHOOKS_ENABLED=true
```

Restart: `pm2 restart voiceagent-queue-processor`

---

### **Issue: Waybeo token not configured warning**

**Symptoms:**
```
‚ö†Ô∏è Waybeo auth token not configured - skipping telephony webhook
```

**Fix:**
This is expected if token is not set. Add to `.env`:
```bash
WAYBEO_AUTH_TOKEN=<your_token_here>
```

Then restart: `pm2 restart voiceagent-queue-processor`

---

## üìä Monitoring Commands

### **Check Webhook Success Rate:**

```bash
# View recent webhook activity
pm2 logs voiceagent-queue-processor --lines 500 | grep "Webhook summary"

# Count successful vs failed
pm2 logs voiceagent-queue-processor --lines 1000 | \
  grep "Webhook summary" | \
  grep -c "2 delivered, 0 failed"

# Count any failures
pm2 logs voiceagent-queue-processor --lines 1000 | \
  grep "Webhook summary" | \
  grep -c "failed"
```

### **Check Waybeo Deliveries:**

```bash
# View Waybeo webhook deliveries
pm2 logs voiceagent-queue-processor --lines 200 | grep "Waybeo"

# Count successful Waybeo deliveries
pm2 logs voiceagent-queue-processor --lines 1000 | \
  grep -c "Waybeo webhook delivered successfully"
```

### **Check SingleInterface Deliveries:**

```bash
# View SingleInterface webhook deliveries
pm2 logs voiceagent-queue-processor --lines 200 | grep "Single Interface"

# Count successful deliveries
pm2 logs voiceagent-queue-processor --lines 1000 | \
  grep -c "Single Interface webhook delivered successfully"
```

---

## üìû Coordination with Partners

### **Waybeo Team:**

**Information to Share:**
1. We're sending data to `https://pbx-uat.waybeo.com/bot-call`
2. Using Bearer token authentication they provided
3. Sending `data_record` command with parameters array
4. Parameters we send: customer_name, car_model, customer_email, call_status, call_duration_seconds, conversation_language
5. We retry 3 times on failure with exponential backoff

**Information to Get:**
1. Confirm production endpoint URL
2. Production Bearer token
3. Token expiry and refresh mechanism
4. Expected response format on success
5. Any rate limiting we should be aware of

---

### **SingleInterface Team:**

**Information to Share:**
1. We've updated to API v2.0
2. Now sending: Store_code, Customer_number, Duration (capital D)
3. Vendor name changed to "Waybeo"
4. Dealer routing reasons updated to their specified format
5. Dropoff actions now include qq1/qq2

**Information to Get:**
1. Confirm all required fields are present
2. How to provide Store_code and Customer_number (from metadata or config?)
3. Any additional parameters they need
4. Feedback on data quality/format

---

## üéØ Summary

### **What's Working:**

‚úÖ **SingleInterface Webhook v2.0**
- All new fields implemented
- Field names updated
- Vendor name updated  
- Routing reasons standardized
- Dropoff actions extended

‚úÖ **Waybeo Telephony Webhook**
- Bearer token authentication
- Parameters array format
- Conditional parameter inclusion
- Retry logic
- Comprehensive error handling

‚úÖ **Dual Webhook System**
- Both webhooks fire after each call
- Non-blocking (parallel execution)
- Independent retry logic
- Comprehensive logging

### **What's Needed for Production:**

1. **Waybeo Production Token** - Get from Waybeo team
2. **Production Endpoint** - Confirm if different from UAT
3. **Store_code & Customer_number Sources** - Configure how these are provided
4. **Partner Confirmation** - Both Waybeo and SingleInterface confirm data received correctly

---

## üìö Documentation References

- **SingleInterface v2.0**: `WEBHOOK_V2_UPDATE.md`
- **Waybeo Integration**: `WAYBEO_TELEPHONY_WEBHOOK.md`
- **General Webhooks**: `WEBHOOK_DEPLOYMENT.md`
- **This Summary**: `V4.3.0_WEBHOOK_UPDATES_SUMMARY.md`

---

## üéâ Deployment Complete!

Once deployed and tested, v4.3.0 with webhook updates will:

1. ‚úÖ Send complete call data to SingleInterface API v2.0
2. ‚úÖ Send captured data to Waybeo bot-call API
3. ‚úÖ Handle authentication and retries automatically
4. ‚úÖ Log all webhook activity for monitoring
5. ‚úÖ Gracefully handle failures without affecting call processing

**Ready for customer testing and production deployment!**

---

**Version:** v4.3.0-webhook-updates  
**Date:** October 10, 2025  
**Status:** Production Ready ‚úÖ

